# soundspan Configuration
# Copy to .env and edit as needed

# ==============================================================================
# Database Configuration
# ==============================================================================
DATABASE_URL="postgresql://soundspan:soundspan@localhost:5433/soundspan"

# ==============================================================================
# Redis Configuration
# ==============================================================================
# Note: Redis container port is mapped to 6380 to avoid conflicts with other Redis instances
REDIS_URL="redis://localhost:6380"

# ==============================================================================
# OPTIONAL: Docker Compose Host Port Overrides
# ==============================================================================
# Split stack deployment defaults in docker-compose.yml:
# FRONTEND_PORT=3030
# BACKEND_PORT=3006
# POSTGRES_PORT=5432
# REDIS_PORT=6379
#
# For backend API scale-out on a single Docker host, set:
# BACKEND_PORT=0
# so each backend replica can publish without host-port collisions.
#
# Optional services defaults in docker-compose.services.yml:
# LIDARR_PORT=8686
#
# Local host-run development (docker-compose.local.yml + npm run dev) intentionally
# uses +1 ports in docs/scripts (3007/3031/5433/6380) to avoid collisions.

# ==============================================================================
# REQUIRED: Path to your music library
# ==============================================================================
MUSIC_PATH=/path/to/your/music
# DEVELOPMENT: Use your local path (e.g., /home/user/Music)
# DOCKER: This is the HOST path that gets mounted to /music in the container
#         The backend inside Docker always uses /music, not this value.
#         Example: MUSIC_PATH=~/Music  (container mounts as ~/Music:/music)

# ==============================================================================
# REQUIRED: Security Keys
# ==============================================================================

# Encryption key for sensitive data (API keys, passwords, 2FA secrets)
# CRITICAL: You MUST set this before starting soundspan
# Generate with: openssl rand -base64 32
SETTINGS_ENCRYPTION_KEY=

# Session secret (auto-generated if not set)
# Generate with: openssl rand -base64 32
SESSION_SECRET=

# Shared internal API secret used for service-to-service callbacks
# (required for CLAP analyzer -> backend callback auth in local dev)
INTERNAL_API_SECRET=soundspan-internal-secret-change-me

# ==============================================================================
# OPTIONAL: Customize these if needed
# ==============================================================================

# Port to access soundspan (default: 3030)
PORT=3030

# Timezone (default: UTC)
TZ=UTC

# Logging level (default: debug in development, warn in production)
# Options: debug, info, warn, error, silent
LOG_LEVEL=debug

# Frontend browser log level (build-time only for Next.js client bundle)
# Options: debug, info, warn, error, silent
# NEXT_PUBLIC_LOG_LEVEL=warn

# Experimental segmented-streaming runtime controls
# STREAMING_ENGINE_MODE=howler
# STREAMING_ENGINE_MODE=videojs  # segmented playback (experimental)
# SEGMENTED_STARTUP_FALLBACK_TIMEOUT_MS=5000
# LISTEN_TOGETHER_SEGMENTED_PLAYBACK_ENABLED=false
# HOWLER_IOS_LOCKSCREEN_WORKAROUNDS_ENABLED=false

# Backend runtime role:
# - all: combined API + workers
# - api: API/sockets only
# - worker: worker-only runtime (used by backend-worker profile/service)
# BACKEND_PROCESS_ROLE=all

# Worker health endpoint port (worker runtime only)
# WORKER_HEALTH_PORT=3010

# Cross-replica Listen Together controls (keep enabled for scale-out)
# LISTEN_TOGETHER_REDIS_ADAPTER_ENABLED=true
# LISTEN_TOGETHER_STATE_SYNC_ENABLED=true
# LISTEN_TOGETHER_STATE_STORE_ENABLED=true
# LISTEN_TOGETHER_STATE_STORE_TTL_SECONDS=21600
# LISTEN_TOGETHER_STATE_STORE_KEY_PREFIX=listen-together:state
# LISTEN_TOGETHER_MUTATION_LOCK_ENABLED=true
# LISTEN_TOGETHER_MUTATION_LOCK_TTL_MS=3000
# LISTEN_TOGETHER_MUTATION_LOCK_PREFIX=listen-together:mutation-lock
# LISTEN_TOGETHER_RECONNECT_SLO_MS=5000
# SCHEDULER_CLAIM_SKIP_WARN_THRESHOLD=3
# DISCOVER_PROCESSOR_LOCK_TTL_MS=2700000
# ENRICHMENT_CLAIM_TTL_MS=900000
# MOOD_BUCKET_CLAIM_TTL_MS=120000

# Optional worker/database tuning
# DATABASE_POOL_SIZE=20
# DATABASE_POOL_TIMEOUT=30

# Allow public access to API documentation in production (default: false)
# Set to 'true' to make /api/docs accessible without authentication in production
# Development mode always allows public access
# DOCS_PUBLIC=true

# AIO image repository (defaults to GHCR)
SOUNDSPAN_AIO_IMAGE=ghcr.io/soundspan/soundspan

# Version tag (use 'latest' or specific like 'v1.0.0')
VERSION=latest

# ==============================================================================
# OPTIONAL: Audio Analyzer Configuration
# ==============================================================================

# Audio Analyzer CPU Control
# NUM_WORKERS=2                   # Number of parallel worker processes (1-8, default: 2)
# THREADS_PER_WORKER=1            # Threads per worker for TensorFlow/FFT (1-4, default: 1)
# Formula: max_cpu_usage ≈ WORKERS × (THREADS_PER_WORKER + 1) × 100%
# Example: 2 workers × (1 thread + 1 overhead) = ~400% CPU (4 cores)

# Audio Analyzer Timeout Configuration
# STALE_PROCESSING_MINUTES=15     # Timeout for tracks stuck in 'processing' state (default: 15)
#                                 # MUST match backend cleanup threshold to prevent race conditions
# MAX_ANALYZE_SECONDS=90          # Seconds of audio to analyze per track (default: 90)
#                                 # Limits memory usage - full tracks analyzed in chunks
# BATCH_SIZE=10                   # Number of tracks to process in parallel (default: 10)
# MAX_RETRIES=3                   # Maximum retry attempts per track before permanent failure (default: 3)

# Audio Analyzer Idle Optimization
# AUDIO_BRPOP_TIMEOUT=30          # Redis BRPOP timeout in seconds (default: 30)
#                                 # Also controls DB reconciliation interval
# AUDIO_MODEL_IDLE_TIMEOUT=300    # Seconds before unloading ML models when idle (default: 300)
#                                 # Set to 0 to keep models loaded permanently

# ==============================================================================
# OPTIONAL: TIDAL Downloader Configuration
# ==============================================================================

# Delay (in seconds) between downloading each track in an album.
# Prevents rate-limiting / bans from TIDAL's API.
# Set to 0 to disable (not recommended). Higher values are safer for large libraries.
# TIDAL_TRACK_DELAY=3

# ==============================================================================
# OPTIONAL: Lidarr Webhook Configuration
# ==============================================================================

# soundspan callback URL - How Lidarr can reach soundspan backend for webhooks
# DOCKER SAME-NETWORK: Use service name (http://backend:3006)
# DOCKER EXTERNAL: Use host IP (http://192.168.1.100:3006 or http://host.docker.internal:3006)
# STANDALONE LIDARR: Use external URL (http://yourserver:3006)
# Default: http://backend:3006 (assumes Lidarr and soundspan are on same Docker network)
SOUNDSPAN_CALLBACK_URL=http://backend:3006

# TROUBLESHOOTING: If you get "Name does not resolve (backend:3006)" errors in Lidarr logs:
# 1. Ensure Lidarr and Backend are on the same Docker network (default: soundspan_network)
# 2. Try using the service/network alias: http://backend:3006
# 3. Try using the host gateway: http://host.docker.internal:3006
# 4. Use your host's LAN IP: http://192.168.1.100:3006
#
# Solution:
# - Check networks: docker network inspect soundspan_network
# - If Lidarr is on different network, use external IP instead: http://<your-ip>:3006
# - Then update Lidarr → Settings → Connect → soundspan webhook URL to match
