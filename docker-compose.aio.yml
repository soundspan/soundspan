# soundspan all-in-one (AIO) deployment.
#
# Use this when you want one container that bundles frontend+backend+db+redis.
# This is the simplest path for production-style single-host installs.
#
# Usage:
#   1. Set MUSIC_PATH and secrets in your .env
#   2. docker compose -f docker-compose.aio.yml up -d
#   3. Open http://localhost:3030
#
# Add optional acquisition/indexer tools with:
#   docker compose -f docker-compose.aio.yml -f docker-compose.services.yml up -d

services:
  soundspan:
    image: ${SOUNDSPAN_AIO_IMAGE:-ghcr.io/soundspan/soundspan}:${VERSION:-latest}
    container_name: ${SOUNDSPAN_AIO_CONTAINER_NAME:-soundspan}
    ports:
      - "${PORT:-3030}:3030"
    volumes:
      # REQUIRED: Path to your music library
      - ${MUSIC_PATH:-/path/to/your/music}:/music
      # Persistent data (database, cache, etc.)
      - soundspan_data:/data
    environment:
      - TZ=${TZ:-UTC}
      - SESSION_SECRET=${SESSION_SECRET:-}
      # Runtime streaming-engine selector. Keep unset for primary howler (direct).
      # Set to videojs (segmented, experimental) only for explicit evaluation.
      - STREAMING_ENGINE_MODE=${STREAMING_ENGINE_MODE:-}
      # Preserve Redis streams/groups across restarts unless explicitly overridden
      - REDIS_FLUSH_ON_STARTUP=${REDIS_FLUSH_ON_STARTUP:-false}
      # Lidarr webhook callback URL - how Lidarr reaches soundspan when downloads complete
      # Default uses host.docker.internal which works on most setups with extra_hosts below
      # Override if using custom Docker networks: e.g., http://192.168.0.20:3030
      - SOUNDSPAN_CALLBACK_URL=${SOUNDSPAN_CALLBACK_URL:-http://host.docker.internal:3030}
    # Makes host.docker.internal work on Linux (already works on Docker Desktop)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "/app/healthcheck.js"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

volumes:
  soundspan_data:
    name: ${SOUNDSPAN_AIO_DATA_VOLUME:-soundspan_data}
